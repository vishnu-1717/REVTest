generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Commission {
  id               String    @id @default(cuid())
  amount           Decimal   @db.Decimal(10, 2)
  percentage       Decimal?  @db.Decimal(5, 2)
  status           String    @default("pending")
  releasedAmount   Decimal   @default(0) @db.Decimal(10, 2)
  totalAmount      Decimal   @default(0) @db.Decimal(10, 2)
  releaseStatus    String    @default("pending")
  overrideAmount   Decimal?  @db.Decimal(10, 2)
  overrideReason   String?
  overrideByUserId String?
  calculatedAt     DateTime  @default(now())
  approvedAt       DateTime?
  paidAt           DateTime?
  saleId           String    @unique
  repId            String
  companyId        String
  Company          Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  User             User      @relation(fields: [repId], references: [id], onDelete: Cascade)
  Sale             Sale      @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([repId])
  @@index([status])
}

model Company {
  id                   String    @id @default(cuid())
  name                 String
  email                String    @unique
  processor            String
  processorAccountId   String?
  processorConnectedAt DateTime?
  inviteCode           String?   @unique

  // GHL Integration
  ghlApiKey        String?
  ghlLocationId    String?
  ghlWebhookSecret String?
  timezone         String  @default("UTC")

  // Attribution Strategy
  attributionStrategy String @default("ghl_fields")
  // Options: "ghl_fields", "calendars", "hyros", "tags", "none"

  attributionSourceField String? @default("contact.source")
  // For "ghl_fields" strategy: which field to pull from

  useCalendarsForAttribution Boolean @default(false)
  // For "calendars" strategy: enable calendar categorization

  // Slack Integration
  slackWorkspaceId   String?
  slackWorkspaceName String?
  slackBotToken      String? // Bot token (xapp) for API calls
  slackAppId         String?
  slackClientId      String?
  slackClientSecret  String? // Note: Should be encrypted, stored in env for security
  slackSigningSecret String? // Note: Should be encrypted, stored in env for security
  slackConnectedAt   DateTime?
  slackChannelId     String? // Default channel for PCN notifications (optional)

  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  Commission       Commission[]
  Sale             Sale[]
  User             User[]
  Contact          Contact[]
  TrafficSource    TrafficSource[]
  Appointment      Appointment[]
  WebhookEvent     WebhookEvent[]
  CommissionRole   CommissionRole[]
  PaymentLink      PaymentLink[]
  UnmatchedPayment UnmatchedPayment[]
  calendars        Calendar[]
  slackMessages    SlackMessage[]

  @@index([email])
}

// ==========================================
// CALENDAR MODEL
// ==========================================

model Calendar {
  id String @id @default(cuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // GHL data
  ghlCalendarId String  @unique
  name          String
  description   String?
  isActive      Boolean @default(true)

  // OPTIONAL: For companies that use calendars for attribution (like BudgetDog)
  trafficSource String?
  calendarType  String?

  // Mark calendars as approved for closer appointments
  // Only appointments from approved calendars will be created
  isCloserCalendar Boolean @default(false)

  // OPTIONAL: Default closer for this calendar (not automatically assigned - for reference only)
  defaultCloserId String?
  defaultCloser   User?   @relation(fields: [defaultCloserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  appointments Appointment[]

  @@index([companyId])
  @@index([ghlCalendarId])
  @@index([trafficSource])
}

model Sale {
  id                 String            @id @default(cuid())
  amount             Decimal           @db.Decimal(10, 2)
  currency           String            @default("USD")
  status             String
  processor          String
  externalId         String            @unique
  processorFees      Decimal?          @db.Decimal(10, 2)
  netAmount          Decimal?          @db.Decimal(10, 2)
  source             String?
  customerEmail      String?
  customerName       String?
  rawData            Json?
  paidAt             DateTime?
  paymentType        String?
  totalAmount        Float?
  remainingAmount    Float?
  matchedBy          String?
  matchConfidence    Float?
  manuallyMatched    Boolean           @default(false)
  matchedByUserId    String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  repId              String?
  contactId          String?
  companyId          String
  paymentLinkId      String?
  appointmentId      String?
  Commission         Commission?
  Company            Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  User               User?             @relation(fields: [repId], references: [id])
  Contact            Contact?          @relation(fields: [contactId], references: [id])
  PaymentLink        PaymentLink?      @relation(fields: [paymentLinkId], references: [id])
  appointmentForSale Appointment?      @relation("AppointmentSale")
  Appointment        Appointment?      @relation("AppointmentMatches", fields: [appointmentId], references: [id])
  UnmatchedPayment   UnmatchedPayment?

  @@index([companyId])
  @@index([externalId])
  @@index([paidAt])
  @@index([repId])
  @@index([status])
}

model User {
  id                   String  @id @default(cuid())
  email                String  @unique
  name                 String
  role                 String
  superAdmin           Boolean @default(false)
  clerkId              String? @unique
  companyId            String
  commissionRoleId     String?
  customCommissionRate Float?
  canViewTeamMetrics   Boolean @default(false)
  canViewLeaderboard   Boolean @default(true)
  isActive             Boolean @default(true)
  customFields         Json?

  // Map to GHL user for auto-assignment
  ghlUserId String? @unique

  // Slack Integration
  slackUserId   String? // Slack user ID for tagging in messages
  slackUserName String? // Slack display name (for reference)

  createdAt                DateTime        @default(now())
  updatedAt                DateTime        @updatedAt
  Commission               Commission[]
  Sale                     Sale[]
  Company                  Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  commissionRole           CommissionRole? @relation(fields: [commissionRoleId], references: [id])
  AppointmentsAsCloser     Appointment[]   @relation("CloserAppointments")
  AppointmentsAsSetter     Appointment[]   @relation("SetterAppointments")
  assignedCalendars        Calendar[]
  pcnSubmittedAppointments Appointment[]   @relation("PCNSubmissions")

  @@index([companyId])
  @@index([email])
  @@index([ghlUserId])
}

model WebhookEvent {
  id          String    @id @default(cuid())
  processor   String
  eventType   String
  companyId   String?
  payload     Json
  processed   Boolean   @default(false)
  processedAt DateTime?
  error       String?
  createdAt   DateTime  @default(now())
  Company     Company?  @relation(fields: [companyId], references: [id])

  @@index([createdAt])
  @@index([processed])
  @@index([processor, eventType])
  @@index([companyId])
}

model Contact {
  id           String  @id @default(cuid())
  name         String
  email        String?
  phone        String?
  companyId    String
  ghlContactId String?
  customFields Json?

  // GHL tags (for attribution via tags strategy)
  tags String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  trafficSource TrafficSource? @relation(fields: [trafficSourceId], references: [id])

  trafficSourceId String?
  Appointment     Appointment[]
  Sale            Sale[]

  @@index([companyId, email])
  @@index([ghlContactId])
}

model TrafficSource {
  id          String   @id @default(cuid())
  name        String
  type        String
  companyId   String
  monthlyCost Float?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company     Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  Contact     Contact[]
  Appointment Appointment[]

  @@index([companyId])
}

model Appointment {
  id                     String    @id @default(cuid())
  scheduledAt            DateTime
  startTime              DateTime?
  endTime                DateTime?
  companyId              String
  contactId              String
  closerId               String?
  setterId               String?
  trafficSourceId        String?
  calendar               String?
  status                 String
  outcome                String?
  objectionType          String?
  objectionNotes         String?   @db.Text
  notes                  String?   @db.Text
  isFirstCall            Boolean   @default(true)
  duration               Int?
  recordingUrl           String?
  followUpScheduled      Boolean   @default(false)
  followUpDate           DateTime?
  nurtureType            String?
  qualificationStatus    String?
  disqualificationReason String?
  cashCollected          Float?
  saleId                 String?   @unique
  ghlAppointmentId       String?
  customFields           Json?

  // Link to calendar
  calendarId       String?
  calendarRelation Calendar? @relation(fields: [calendarId], references: [id], onDelete: SetNull)

  // Attribution (resolved from company's strategy)
  attributionSource String?
  leadSource        String? // "ghl_field", "calendar", "hyros", "tag"

  // PCN submission tracking
  pcnSubmitted         Boolean   @default(false)
  pcnSubmittedAt       DateTime?
  pcnSubmittedByUserId String?
  pcnSubmittedBy       User?     @relation("PCNSubmissions", fields: [pcnSubmittedByUserId], references: [id], onDelete: SetNull)

  // PCN call details
  firstCallOrFollowUp   String?
  wasOfferMade          Boolean?
  whyDidntMoveForward   String?
  notMovingForwardNotes String?  @db.Text

  // No-show specific
  noShowCommunicative      Boolean?
  noShowCommunicativeNotes String?  @db.Text

  // Cancellation specific
  cancellationReason String? @db.Text
  cancellationNotes  String? @db.Text

  // Signed specific
  signedNotes String? @db.Text

  // Appointment inclusion flag for metrics
  // 0 or null = don't count (superseded), 1 = first countable, 2+ = follow-up
  appointmentInclusionFlag Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contact       Contact        @relation(fields: [contactId], references: [id])
  closer        User?          @relation("CloserAppointments", fields: [closerId], references: [id])
  setter        User?          @relation("SetterAppointments", fields: [setterId], references: [id])
  trafficSource TrafficSource? @relation(fields: [trafficSourceId], references: [id])
  sale          Sale?          @relation("AppointmentSale", fields: [saleId], references: [id])
  matchedSales  Sale[]         @relation("AppointmentMatches")
  paymentLinks  PaymentLink[]
  slackMessage  SlackMessage?

  @@index([companyId])
  @@index([closerId])
  @@index([setterId])
  @@index([status])
  @@index([ghlAppointmentId])
  @@index([calendarId])
  @@index([attributionSource])
  @@index([pcnSubmitted])
  @@index([pcnSubmittedAt])
  @@index([appointmentInclusionFlag])
  @@index([contactId, scheduledAt])
  // Compound index for pending PCN queries - optimizes WHERE companyId + pcnSubmitted + status + scheduledAt
  @@index([companyId, pcnSubmitted, status, scheduledAt])
}

model CommissionRole {
  id          String   @id @default(cuid())
  name        String
  defaultRate Float
  description String?
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  users       User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([companyId, name])
  @@index([companyId])
}

model PaymentLink {
  id            String    @id @default(cuid())
  appointmentId String
  companyId     String
  token         String    @unique
  expiresAt     DateTime?
  opens         Int       @default(0)
  lastOpenedAt  DateTime?
  amount        Float
  paymentType   String
  status        String    @default("pending")
  paidAt        DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sales       Sale[]

  @@index([token])
  @@index([appointmentId])
}

model UnmatchedPayment {
  id               String    @id @default(cuid())
  saleId           String    @unique
  companyId        String
  suggestedMatches Json?
  status           String    @default("pending")
  reviewedAt       DateTime?
  reviewedByUserId String?
  createdAt        DateTime  @default(now())

  sale    Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, status])
}

model SlackMessage {
  id             String    @id @default(cuid())
  appointmentId  String    @unique
  companyId      String
  slackChannelId String?
  slackMessageTs String?   // Slack message timestamp (thread ID)
  slackThreadTs  String?   // Thread timestamp if in thread
  
  // Audit and logging fields
  status         String    @default("pending") // "pending", "sent", "failed"
  messageContent String?   @db.Text // The actual message text sent
  closerId       String?   // Which closer was tagged
  closerName     String?   // Closer name for reference
  contactName    String?   // Contact name for reference
  contactEmail   String?   // Contact email for reference
  scheduledAt    DateTime? // Appointment scheduled time
  channelType    String?   // "channel", "dm", "default_channel"
  errorMessage   String?   @db.Text // Error details if failed
  retryCount     Int       @default(0) // Number of retry attempts
  sentAt         DateTime? // When notification was successfully sent
  failedAt       DateTime? // When notification failed
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @default(now()) @updatedAt

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([appointmentId])
  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt])
}
