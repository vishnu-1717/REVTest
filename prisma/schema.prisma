generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  directUrl    = env("DIRECT_URL")
  relationMode = "prisma"
}

model Company {
  id                   String       @id @default(uuid())
  name                 String
  email                String       @unique
  processor            String
  processorAccountId   String?
  processorConnectedAt DateTime?
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
  commissions          Commission[]
  sales                Sale[]
  users                User[]

  @@index([email])
}

model User {
  id          String       @id @default(uuid())
  email       String       @unique
  name        String
  role        String
  companyId   String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  commissions Commission[]
  sales       Sale[]
  company     Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([email])
}

model Sale {
  id            String      @id @default(uuid())
  amount        Decimal     @db.Decimal(10, 2)
  currency      String      @default("USD")
  status        String
  processor     String
  externalId    String      @unique
  processorFees Decimal?    @db.Decimal(10, 2)
  netAmount     Decimal?    @db.Decimal(10, 2)
  source        String?
  customerEmail String?
  customerName  String?
  rawData       Json?
  paidAt        DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  repId         String?
  companyId     String
  commission    Commission?
  company       Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  rep           User?       @relation(fields: [repId], references: [id])

  @@index([companyId])
  @@index([repId])
  @@index([status])
  @@index([paidAt])
  @@index([externalId])
}

model Commission {
  id           String    @id @default(uuid())
  amount       Decimal   @db.Decimal(10, 2)
  percentage   Decimal?  @db.Decimal(5, 2)
  status       String    @default("pending")
  calculatedAt DateTime  @default(now())
  approvedAt   DateTime?
  paidAt       DateTime?
  saleId       String    @unique
  repId        String
  companyId    String
  company      Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  rep          User      @relation(fields: [repId], references: [id], onDelete: Cascade)
  sale         Sale      @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([repId])
  @@index([status])
}

model WebhookEvent {
  id          String    @id @default(uuid())
  processor   String
  eventType   String
  payload     Json
  processed   Boolean   @default(false)
  processedAt DateTime?
  error       String?
  createdAt   DateTime  @default(now())

  @@index([processor, eventType])
  @@index([processed])
  @@index([createdAt])
}
